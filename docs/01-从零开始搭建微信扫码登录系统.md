# 从零开始搭建微信扫码登录系统（上）：架构设计与环境搭建

## 前言

大家好，我是xiaou。在这个移动互联的时代，微信已经成为了我们生活中不可或缺的一部分。作为一名开发者，我经常思考如何能够利用微信公众号的能力，为用户提供更便捷的登录体验。传统的账号密码登录方式不仅繁琐，还需要用户记住各种复杂的密码，而扫码登录则能极大地提升用户体验。

最近，我接到了一个需求：为公司的Web应用接入微信扫码登录功能。在调研了多种方案后，我选择了基于微信公众号的扫码登录方案。今天，我将和大家分享我从零开始搭建微信扫码登录系统的完整过程。

## 项目背景

### 技术选型

经过综合考虑，我选择了以下技术栈：

- **后端框架**：Spring Boot 3.x
- **微信SDK**：WxJava（me.chanjar.weixin）
- **缓存**：Redis（用于存储扫码状态）
- **构建工具**：Maven
- **开发工具**：IntelliJ IDEA

## 项目架构设计

### 整体架构

![](./images/wechat-mp-01.png)

### 核心模块设计

1. **配置模块**（WxMpConfiguration）：负责微信公众号的配置和消息路由
2. **控制器模块**（Controller）：处理 HTTP 请求，包括二维码生成、状态查询等
3. **处理器模块**（Handler）：处理微信推送的各种事件
4. **缓存模块**（Redis）：存储二维码状态和登录信息
5. **工具类模块**（Utils）：提供通用的工具方法

## 环境搭建

### 1. 创建 Spring Boot 项目

首先，我们需要创建一个新的 Spring Boot 项目。可以通过 Spring Initializr 或者直接在 IDE 中创建。

### 2. 添加依赖

在`pom.xml`中添加必要的依赖：

```xml
<dependencies>
    <!-- Spring Boot Starter Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Spring Boot Starter Data Redis -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>

    <!-- WxJava 微信开发工具包 -->
    <dependency>
        <groupId>com.github.binarywang</groupId>
        <artifactId>weixin-java-mp</artifactId>
        <version>4.5.0</version>
    </dependency>

    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>

    <!-- 其他依赖... -->
</dependencies>
```

### 3. 配置微信公众号

首先，你需要有一个认证过微信公众号。登录公众号后台，获取以下信息：

- **AppID**：公众号的唯一标识
- **AppSecret**：公众号的密钥
- **Token**：消息验证Token
- **EncodingAESKey**：消息加密密钥（如果选择安全模式）

可以申请测试公众号 [链接](https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login)

### 4. 配置Redis

确保你的环境中已经安装并启动了 Redis 服务。在 `application.yml` 中配置 Redis 连接：

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password:
    database: 0
    timeout: 5000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
```

## 项目结构

```
src/main/java/cn/xiaou/weixin/mp/demo/
├── WechatMpApplication.java          # 启动类
├── config/
│   └── WxMpConfiguration.java        # 微信配置类
├── controller/
│   ├── WxPortalController.java       # 微信消息接收入口
│   ├── WxUserController.java         # 用户相关接口
│   ├── WxQrcodeLogin.java            # 扫码登录实体
│   └── vo/                           # 视图对象
├── handler/
│   ├── AbstractHandler.java          # 抽象处理器
│   ├── LoginAndRegisterHandler.java  # 登录注册处理器
│   └── SubscribeHandler.java         # 关注事件处理器
├── builder/
│   ├── AbstractBuilder.java          # 抽象消息构建器
│   ├── TextBuilder.java              # 文本消息构建器
│   └── ImageBuilder.java             # 图片消息构建器
├── redis/
│   └── WxRedis.java                  # Redis操作工具类
├── enums/
│   ├── WxQrcodeSceneType.java        # 二维码场景类型
│   └── WxQrcodeStatus.java           # 二维码状态
└── utils/
    ├── CommonResult.java             # 通用返回结果
    ├── ErrorCode.java                # 错误码定义
    ├── ServiceException.java         # 服务异常
    └── ...
```

## 核心枚举定义

### 二维码状态枚举

```java
@AllArgsConstructor
@Getter
public enum WxQrcodeStatus {
    /**
     * 等待扫码
     */
    WAIT_SCAN(1),
    /**
     * 已扫码，等待确认
     */
    SCANNED(2),
    /**
     * 登录成功
     */
    CONFIRMED(3),
    /**
     * 已过期
     */
    EXPIRED(4);

    private final Integer value;
}
```

### 二维码场景类型枚举

```java
@AllArgsConstructor
@Getter
public enum WxQrcodeSceneType {
    /**
     * 登录或者注册
     */
    LOGIN_OR_REGISTER,
    ;

    public String getEventKeyRegex() {
        return "^(qrscene_)?" + this.name() +"#.*";
    }
}
```

## 第一个里程碑：消息接收

在开发之初，我们首先需要确保能够正常接收来自微信服务器的消息。`WxPortalController`是我们的第一个重要组件：

```java
@RestController
@RequestMapping("/wx/portal/{appId}")
public class WxPortalController {

    @GetMapping(produces = "text/plain;charset=utf-8")
    public String authGet(@PathVariable String appId,
                         @RequestParam String signature,
                         @RequestParam String timestamp,
                         @RequestParam String nonce,
                         @RequestParam String echostr) {
        // 验证消息真实性
        if (wxMpService.checkSignature(timestamp, nonce, signature)) {
            return echostr;
        }
        return "非法请求";
    }

    @PostMapping(produces = "application/xml; charset=UTF-8")
    public String post(@PathVariable String appId,
                      @RequestBody String requestBody,
                      // ... 其他参数
                      ) {
        // 处理微信推送的消息
        WxMpXmlMessage inMessage = WxMpXmlMessage.fromXml(requestBody);
        WxMpXmlOutMessage outMessage = messageRouter.route(inMessage);
        return outMessage != null ? outMessage.toXml() : "";
    }
}
```

## 遇到的第一个坑

在配置消息接收URL时，我遇到了第一个问题：微信服务器一直提示"Token验证失败"。经过排查，发现是因为：

1. **URL必须是80端口或443端口**：微信要求必须是公网可访问的URL
2. **签名算法必须正确**：不能有任何的空格或换行符
3. **返回值必须是纯文本**：不能包含任何HTML标签

解决方案是使用ngrok等内网穿透工具进行本地调试，确保URL格式正确。

## 总结

今天，我们一起完成了微信扫码登录系统的架构设计和基础环境搭建。虽然还没有实现完整的扫码登录功能，但已经为后续的开发打下了坚实的基础。

**下一篇预告：** 我们将深入探讨二维码生成、状态管理、消息处理等核心功能的实现，以及我在开发过程中遇到的那些有趣的坑和解决方案。

## 参考资源

- [WxJava官方文档](https://github.com/Wechat-Group/WxJava)
- [微信公众号开发文档](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
- [Redis官方文档](https://redis.io/documentation)

---

*作者：xiaou
日期：2025年12月11日*